<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rural-Friendly Attendance Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f4f7f9;
        }
        .container {
            max-width: 600px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        video, canvas {
            background-color: #333;
            border-radius: 12px;
            border: 2px solid #ddd;
        }
        .capture-zone {
            position: relative;
        }
        .capture-zone::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translate(-50%, -50%);
            border: 2px dashed #a8a8a8;
            border-radius: 12px;
        }
        .status-icon {
            filter: grayscale(100%);
        }
        .status-online {
            filter: none;
            color: #22c55e;
        }
    </style>
</head>
<body>
    <div id="app" class="container p-4">
        <!-- Header & Nav -->
        <header class="flex justify-between items-center py-4 mb-4 border-b-2 border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800">Attendance System</h1>
            <div class="flex space-x-2">
                <button onclick="changeView('dashboard')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                </button>
                <button onclick="changeView('enrollment')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                </button>
                <button onclick="changeView('attendance')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                </button>
                <button onclick="changeView('logs')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scroll-text"><path d="M21 10c0-1-1-2-2-2H3c-1 0-2 1-2 2v8a2 2 0 0 0 2 2h16c1 0 2-1 2-2"/><path d="M18.4 8.6c.9 1.4 1.4 3.2 1.4 5.2.4 1.4 0 3.1-.6 4.3"/><path d="M22 17a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2Z"/><path d="M8 12h8"/><path d="M8 18h5"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-2">
            <!-- Dashboard View -->
            <div id="dashboard" class="view hidden">
                <h2 class="text-3xl font-semibold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <div class="text-gray-500 mb-1">Students Enrolled</div>
                        <div id="enrolledCount" class="text-4xl font-bold text-gray-800">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <div class="text-gray-500 mb-1">Today's Attendance</div>
                        <div id="attendanceCount" class="text-4xl font-bold text-gray-800">0 / 0</div>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-semibold mb-4">Admin Details</h3>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-gray-500 mb-2">User ID (for multi-user support)</p>
                        <p id="userIdDisplay" class="font-mono text-sm text-gray-700 break-all">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Enrollment View -->
            <div id="enrollment" class="view hidden">
                <h2 class="text-3xl font-semibold mb-6">Student Enrollment</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                    <p class="text-gray-500 mb-4 text-center text-lg">
                        Step 1: Get consent. <br>
                        <span class="text-sm">(Ensure paper/QR consent is recorded)</span>
                    </p>
                    <input type="text" id="studentName" placeholder="Student Name" class="w-full p-3 mb-4 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="consentCheck" class="flex items-center justify-center space-x-2 mb-6">
                        <input type="checkbox" id="consentCheckbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                        <label for="consentCheckbox" class="text-lg text-gray-700">Guardian Consent Received</label>
                    </div>
                    <div id="enrollmentFlow" class="hidden">
                        <p class="text-gray-500 mb-4 text-center text-lg">Step 2: Capture faces (3-5 angles)</p>
                        <div class="w-full relative mx-auto mb-4 capture-zone" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                            <video id="enrollmentVideo" class="w-full h-full rounded-xl object-cover"></video>
                            <canvas id="enrollmentCanvas" class="hidden"></canvas>
                        </div>
                        <button id="captureBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full w-full mb-4 transition-colors duration-200" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera-off inline-block mr-2"><path d="M11 20H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h3.9a2 2 0 0 0 1.69-.9l.81-1.2A2 2 0 0 1 12.38 3H20a2 2 0 0 1 2 2v9"/><path d="m2 2 20 20"/><path d="M16 16v-2.2c0-.7-.3-1.4-.8-1.9l-1.3-1.3c-.6-.5-1.3-.8-2.1-.8H10l-4-4"/><path d="M12 16h9"/></svg>
                            Capture Face
                        </button>
                        <div id="capturedImages" class="grid grid-cols-2 gap-4 mt-4"></div>
                        <p id="captureFeedback" class="text-sm text-gray-500 mt-2">Captured 0 of 3 images.</p>
                        <button id="saveEnrollmentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full w-full mt-4 transition-colors duration-200" disabled>
                            Save Enrollment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attendance View -->
            <div id="attendance" class="view hidden">
                <h2 class="text-3xl font-semibold mb-6">Take Attendance</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-gray-500 mb-4 text-lg">Please present your face to the camera.</p>
                    <div class="w-full relative mx-auto mb-4 capture-zone" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                        <video id="attendanceVideo" class="w-full h-full rounded-xl object-cover"></video>
                    </div>
                    <div id="recognitionResult" class="text-center p-4 rounded-lg font-bold text-lg hidden"></div>
                    <button id="scanBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full w-full mb-4 transition-colors duration-200">
                        Scan Face
                    </button>
                    <p class="text-center text-sm text-gray-500">
                        <span id="offlineNotice" class="hidden text-red-500">Working Offline. Sync later.</span>
                    </p>
                </div>
            </div>

            <!-- Logs View -->
            <div id="logs" class="view hidden">
                <h2 class="text-3xl font-semibold mb-6">Attendance Logs</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-gray-500 mb-4 text-lg">Today's Attendance List</p>
                    <div class="flex justify-between mb-4">
                        <button id="syncBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                            Sync Data
                        </button>
                        <button id="exportBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                            Export
                        </button>
                    </div>
                    <ul id="attendanceList" class="divide-y divide-gray-200">
                        <li class="py-2 text-gray-500 text-center">No attendance logged today.</li>
                    </ul>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="flex justify-between items-center bg-gray-800 text-white py-2 px-4 rounded-t-xl mt-auto">
            <div class="flex items-center space-x-2">
                <div id="cameraStatus" class="flex items-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video text-gray-500 status-icon"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>
                    <span class="ml-1 hidden md:inline">Camera</span>
                </div>
                <div id="networkStatus" class="flex items-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi text-gray-500 status-icon"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
                    <span class="ml-1 hidden md:inline">Network</span>
                </div>
                <div id="syncStatus" class="flex items-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw status-icon text-gray-500"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.79 2.91L2 12"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.79-2.91L22 12"/><path d="M12 2v10l-4-4"/></svg>
                    <span class="ml-1 hidden md:inline">Sync</span>
                </div>
            </div>
            <a href="#" class="text-sm font-semibold hover:underline">Help & FAQ</a>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase debug logs
        setLogLevel('debug');

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App State & Firebase Setup ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let cameraStream = null;
        let capturedPhotos = [];
        let viewState = 'dashboard';
        const today = new Date().toISOString().slice(0, 10);
        
        // UI elements
        const appEl = document.getElementById('app');
        const views = document.querySelectorAll('.view');
        const cameraStatusEl = document.getElementById('cameraStatus');
        const networkStatusEl = document.getElementById('networkStatus');
        const syncStatusEl = document.getElementById('syncStatus');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const enrolledCountEl = document.getElementById('enrolledCount');
        const attendanceCountEl = document.getElementById('attendanceCount');
        const attendanceListEl = document.getElementById('attendanceList');
        const enrollmentVideo = document.getElementById('enrollmentVideo');
        const attendanceVideo = document.getElementById('attendanceVideo');
        const captureBtn = document.getElementById('captureBtn');
        const saveEnrollmentBtn = document.getElementById('saveEnrollmentBtn');
        const studentNameInput = document.getElementById('studentName');
        const consentCheckbox = document.getElementById('consentCheckbox');
        const capturedImagesContainer = document.getElementById('capturedImages');
        const captureFeedbackEl = document.getElementById('captureFeedback');
        const recognitionResultEl = document.getElementById('recognitionResult');
        const scanBtn = document.getElementById('scanBtn');
        const syncBtn = document.getElementById('syncBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Initialize Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = userId;
                    } else {
                        userId = crypto.randomUUID();
                        userIdDisplayEl.textContent = 'Anonymous';
                    }
                    isAuthReady = true;
                    // Start listening for data and update UI
                    setupRealtimeListeners();
                    changeView(viewState);
                });

                // Sign in with custom token or anonymously
                (async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        console.log("Proceeding with anonymous user.");
                        await signInAnonymously(auth);
                    }
                })();
                
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // Fallback for demo without Firebase
                userId = crypto.randomUUID();
                userIdDisplayEl.textContent = 'Offline Demo';
                isAuthReady = true;
                changeView(viewState);
            }
        }
        
        // --- View & Navigation Logic ---
        function changeView(newView) {
            viewState = newView;
            views.forEach(view => {
                view.style.display = view.id === newView ? 'block' : 'none';
            });
            handleViewSpecifics(newView);
        }

        function handleViewSpecifics(view) {
            // Stop all camera streams
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStatusEl.classList.remove('status-online');
            }
            
            if (view === 'enrollment' || view === 'attendance') {
                startCamera(view === 'enrollment' ? enrollmentVideo : attendanceVideo);
            }
        }

        async function startCamera(videoEl) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoEl.srcObject = stream;
                cameraStream = stream;
                cameraStatusEl.classList.add('status-online');
                // Enable enrollment capture button
                if (videoEl.id === 'enrollmentVideo' && consentCheckbox.checked) {
                    captureBtn.disabled = false;
                }
            } catch (err) {
                console.error("Camera access denied or not available.", err);
                cameraStatusEl.classList.remove('status-online');
                displayMessage('Camera not available. Please check permissions.', 'red');
            }
        }

        function displayMessage(message, color) {
            const resultEl = document.createElement('div');
            resultEl.textContent = message;
            resultEl.className = `fixed inset-x-0 top-0 mx-auto mt-4 p-4 text-center text-white font-bold rounded-lg shadow-lg z-50 transition-all duration-300 transform animate-slide-in`;
            resultEl.style.backgroundColor = color;
            appEl.appendChild(resultEl);
            setTimeout(() => {
                resultEl.remove();
            }, 3000);
        }

        // --- Enrollment Logic ---
        consentCheckbox.addEventListener('change', () => {
            document.getElementById('enrollmentFlow').classList.toggle('hidden', !consentCheckbox.checked);
            if (consentCheckbox.checked) {
                startCamera(enrollmentVideo);
            } else {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            }
        });

        captureBtn.addEventListener('click', () => {
            const video = enrollmentVideo;
            const canvas = document.getElementById('enrollmentCanvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            
            capturedPhotos.push(dataUrl);
            updateCapturedImages();
            captureFeedbackEl.textContent = `Captured ${capturedPhotos.length} of 3 images.`;

            if (capturedPhotos.length >= 3) {
                captureBtn.disabled = true;
                saveEnrollmentBtn.disabled = false;
            }
        });

        function updateCapturedImages() {
            capturedImagesContainer.innerHTML = '';
            capturedPhotos.forEach(dataUrl => {
                const img = document.createElement('img');
                img.src = dataUrl;
                img.className = 'w-full h-auto rounded-lg shadow-md border-2 border-green-500';
                capturedImagesContainer.appendChild(img);
            });
        }

        saveEnrollmentBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                displayMessage('System not ready. Please wait.', 'red');
                return;
            }
            if (capturedPhotos.length < 3) {
                displayMessage('Please capture at least 3 photos.', 'red');
                return;
            }
            const studentName = studentNameInput.value.trim();
            if (!studentName) {
                displayMessage('Please enter student name.', 'red');
                return;
            }

            try {
                // Save to Firestore
                const studentData = {
                    name: studentName,
                    enrollmentDate: Timestamp.now(),
                    photos: capturedPhotos,
                };
                const collectionPath = `/artifacts/${appId}/public/data/students`;
                await addDoc(collection(db, collectionPath), studentData);

                // Reset enrollment view
                capturedPhotos = [];
                updateCapturedImages();
                studentNameInput.value = '';
                consentCheckbox.checked = false;
                document.getElementById('enrollmentFlow').classList.add('hidden');
                captureFeedbackEl.textContent = 'Captured 0 of 3 images.';
                captureBtn.disabled = true;
                saveEnrollmentBtn.disabled = true;
                
                displayMessage('Student enrolled successfully!', '#22c55e');
            } catch (error) {
                console.error("Error saving enrollment:", error);
                displayMessage('Error saving enrollment. Please check network.', 'red');
            }
        });

        // --- Attendance Logic (Simulated) ---
        scanBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                displayMessage('System not ready. Please wait.', 'red');
                return;
            }
            recognitionResultEl.classList.remove('hidden');
            recognitionResultEl.classList.remove('bg-green-100', 'bg-red-100');
            recognitionResultEl.textContent = 'Scanning...';
            
            const studentsCollection = collection(db, `/artifacts/${appId}/public/data/students`);
            const studentsSnapshot = await getDocs(studentsCollection);
            const enrolledStudents = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (enrolledStudents.length === 0) {
                recognitionResultEl.classList.add('bg-red-100', 'text-red-800');
                recognitionResultEl.textContent = 'No students enrolled.';
                return;
            }

            // Simulate face recognition
            const recognizedStudent = enrolledStudents[Math.floor(Math.random() * enrolledStudents.length)];
            const isRecognized = Math.random() > 0.2; // 80% success rate
            
            setTimeout(async () => {
                if (isRecognized) {
                    recognitionResultEl.classList.add('bg-green-100', 'text-green-800');
                    recognitionResultEl.textContent = `✅ Recognized: ${recognizedStudent.name}`;
                    
                    try {
                        // Log attendance
                        const attendanceData = {
                            studentId: recognizedStudent.id,
                            studentName: recognizedStudent.name,
                            timestamp: Timestamp.now(),
                        };
                        const attendanceCollectionPath = `/artifacts/${appId}/public/data/attendance`;
                        await addDoc(collection(db, attendanceCollectionPath), attendanceData);
                        displayMessage('Attendance recorded!', '#22c55e');
                    } catch (error) {
                        console.error("Error logging attendance:", error);
                        displayMessage('Error logging attendance. Please check network.', 'red');
                    }
                } else {
                    recognitionResultEl.classList.add('bg-red-100', 'text-red-800');
                    recognitionResultEl.textContent = `❌ Not Recognized. Please try again.`;
                }
            }, 1000); // Simulate processing time
        });

        // --- Data & Sync Logic ---
        function setupRealtimeListeners() {
            if (!isAuthReady) return;

            const studentsCollectionPath = `/artifacts/${appId}/public/data/students`;
            const attendanceCollectionPath = `/artifacts/${appId}/public/data/attendance`;

            // Listen for changes to student count
            onSnapshot(collection(db, studentsCollectionPath), (snapshot) => {
                enrolledCountEl.textContent = snapshot.size;
            });

            // Listen for today's attendance logs
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date();
            todayEnd.setHours(23, 59, 59, 999);

            const attendanceQuery = query(
                collection(db, attendanceCollectionPath),
                where("timestamp", ">=", Timestamp.fromDate(todayStart)),
                where("timestamp", "<=", Timestamp.fromDate(todayEnd))
            );

            onSnapshot(attendanceQuery, async (snapshot) => {
                const logs = snapshot.docs.map(doc => doc.data());
                const uniqueStudentsPresent = new Set(logs.map(log => log.studentId)).size;
                const studentCount = await getCountFromServer(collection(db, studentsCollectionPath));
                const totalStudents = studentCount.data().count;

                attendanceCountEl.textContent = `${uniqueStudentsPresent} / ${totalStudents}`;
                
                attendanceListEl.innerHTML = '';
                if (logs.length === 0) {
                    attendanceListEl.innerHTML = '<li class="py-2 text-gray-500 text-center">No attendance logged today.</li>';
                } else {
                    const sortedLogs = logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    sortedLogs.forEach(log => {
                        const li = document.createElement('li');
                        li.className = 'py-2 flex justify-between items-center';
                        const time = new Date(log.timestamp.toMillis()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        li.innerHTML = `
                            <span class="font-semibold text-gray-800">${log.studentName}</span>
                            <span class="text-sm text-gray-500">${time}</span>
                        `;
                        attendanceListEl.appendChild(li);
                    });
                }
            });
        }

        syncBtn.addEventListener('click', () => {
            // Firestore handles sync automatically, so this button is for visual feedback
            displayMessage('Syncing data with cloud...', 'orange');
            setTimeout(() => {
                displayMessage('Sync complete!', '#22c55e');
            }, 1500);
        });

        exportBtn.addEventListener('click', async () => {
            const attendanceCollectionPath = `/artifacts/${appId}/public/data/attendance`;
            const logsSnapshot = await getDocs(collection(db, attendanceCollectionPath));
            const logs = logsSnapshot.docs.map(doc => doc.data());

            if (logs.length === 0) {
                displayMessage('No data to export.', 'red');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "StudentName,Timestamp\n";
            logs.forEach(log => {
                const row = `${log.studentName},${new Date(log.timestamp.toMillis()).toISOString()}`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `attendance_log_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            displayMessage('Data exported to CSV!', '#22c55e');
        });

        // --- Network Status Logic ---
        window.addEventListener('online', () => {
            networkStatusEl.classList.add('status-online');
            syncStatusEl.classList.add('status-online');
        });
        window.addEventListener('offline', () => {
            networkStatusEl.classList.remove('status-online');
            syncStatusEl.classList.remove('status-online');
        });
        
        // Initial setup
        window.onload = function() {
            if (navigator.onLine) {
                networkStatusEl.classList.add('status-online');
                syncStatusEl.classList.add('status-online');
            }
            initializeFirebase();
        };

    </script>
</body>
</html>
